#!/usr/bin/env python3
import itertools
import logging

from mitmproxy import http
from mitmproxy.tools import main as mitm_main

# ===== Logging setup =====
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
)
log = logging.getLogger("pentest-proxy")

MAX_BODY_PREVIEW = 50000


class PentestProxy:
    def __init__(self):
        self._id_counter = itertools.count(1)

    # ----------- REQUEST HOOK -----------
    def request(self, flow: http.HTTPFlow):
        rid = flow.metadata.get("rid")
        if rid is None:
            rid = next(self._id_counter)
            flow.metadata["rid"] = rid

        req = flow.request

        log.info("\n======= REQUEST #%s =======", rid)
        log.info("CLIENT: %s", flow.client_conn.address)
        log.info("METHOD: %s", req.method)
        log.info(
            "URL: %s://%s%s",
            req.scheme, req.host, req.path
        )
        log.info("HTTP VERSION: %s", req.http_version)

        log.info("----- HEADERS -----")
        for k, v in req.headers.items():
            log.info("%s: %s", k, v)

        if req.raw_content:
            body = req.raw_content[:MAX_BODY_PREVIEW]
            log.info("----- BODY (truncated) -----")
            log.info(body.decode("utf-8", errors="replace"))

        log.info("======= END REQUEST #%s =======\n", rid)

        # ======================================
        #   INTERACTIVE PATH MODIFICATION
        # ======================================
        print(f"\nCurrent path: {req.path}")
        new_path = input("Enter new path (or ENTER to keep): ").strip()

        if new_path:
            log.info(f"[#{rid}] → PATH MODIFIED: {req.path} → {new_path}")
            req.path = new_path
        else:
            log.info(f"[#{rid}] → Path unchanged.")

        # ======================================
        #   APPROVE OR BLOCK PROMPT
        # ======================================
        while True:
            user = input(f"Allow request #{rid}? (y/n): ").strip().lower()
            if user == "y":
                log.info(f"[#{rid}] → APPROVED — sending.")
                return
            elif user == "n":
                log.info(f"[#{rid}] → BLOCKED.")

                # Provide synthetic response
                flow.response = http.Response.make(
                    403,
                    f"Request #{rid} BLOCKED by interactive proxy.",
                    {"Content-Type": "text/plain"}
                )
                return
            else:
                print("Enter y or n.")

    # ----------- RESPONSE HOOK -----------
    def response(self, flow: http.HTTPFlow):
        rid = flow.metadata.get("rid", "?")
        resp = flow.response

        log.info("\n======= RESPONSE #%s =======", rid)
        log.info("STATUS: %s %s", resp.status_code, resp.reason)
        log.info("HTTP VERSION: %s", resp.http_version)

        log.info("----- HEADERS -----")
        for k, v in resp.headers.items():
            log.info("%s: %s", k, v)

        if resp.raw_content:
            body = resp.raw_content[:MAX_BODY_PREVIEW]
            log.info("----- BODY (truncated) -----")
            log.info(body.decode("utf-8", errors="replace"))

        log.info("======= END RESPONSE #%s =======\n")


addons = [PentestProxy()]

if __name__ == "__main__":
    mitm_main.mitmdump(["-s", __file__])
